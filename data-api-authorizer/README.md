# Data API Authorizer

A lightweight Lambda authorizer that validates API key authentication for the data-api-server HTTP API.

## Overview

This authorizer provides simple, secure API key authentication for the Data API. It runs as a separate Lambda function that API Gateway invokes before forwarding requests to the data-api-server.

### How It Works

1. **Client Request**: Client sends request with `x-api-key` header
2. **API Gateway**: Intercepts request and invokes this authorizer Lambda
3. **Authorizer**: Validates API key against secret stored in AWS Secrets Manager
4. **Authorization Decision**: Returns `isAuthorized: true/false` to API Gateway
5. **API Gateway**: Either forwards request to data-api-server (authorized) or returns 403 (denied)
6. **Caching**: API Gateway caches authorization decisions for 5 minutes per API key

### Architecture Benefits

- **Security at Gateway Layer**: Authentication happens before reaching your application
- **Performance**: Authorization decisions are cached (reduces Lambda invocations)
- **Separation of Concerns**: Authorizer is independent of the data-api-server
- **Cost Efficient**: Lightweight function with minimal memory (256 MB) and fast execution
- **Auto-Generated Keys**: API key is securely generated by AWS Secrets Manager during deployment

## Implementation Details

### API Key Storage

The API key is stored in AWS Secrets Manager:
- **Secret Name**: `{ENV}/ai-voice-tool/data-api-key`
- **Auto-Generated**: 48-character secure random string
- **Format**: JSON with `api_key` field: `{"api_key": "..."}`

### Authorizer Configuration

- **Type**: REQUEST authorizer (evaluates entire request)
- **Identity Source**: `x-api-key` header (case-insensitive)
- **Cache TTL**: 300 seconds (5 minutes)
- **Payload Format**: 2.0 (simplified response format)
- **Simple Responses**: Enabled (returns `isAuthorized` boolean)

### Lambda Function

- **Runtime**: Python 3.13 on Lambda container
- **Memory**: 256 MB
- **Timeout**: 10 seconds
- **Cold Start**: ~500ms (first invocation only)
- **Warm Execution**: ~50-100ms (subsequent invocations)

### IAM Permissions

The authorizer Lambda has minimal permissions:
- `secretsmanager:GetSecretValue` on the data-api-key secret only
- `logs:CreateLogStream` and `logs:PutLogEvents` for CloudWatch Logs

## Usage

### For Clients

Include the `x-api-key` header in all requests to the Data API:

```bash
curl -X GET "https://your-api-url/files/list?company_id=123&message_intent=job-to-be-done" \
  -H "x-api-key: YOUR_API_KEY_HERE"
```

The header name is case-insensitive (`x-api-key`, `X-API-Key`, or `X-Api-Key` all work).

### Retrieving the API Key

After deploying the shared infrastructure, retrieve the API key:

```bash
# Retrieve the API key for dev environment
aws secretsmanager get-secret-value \
  --secret-id dev/ai-voice-tool/data-api-key \
  --region ap-southeast-2 \
  --profile cohesv \
  --query 'SecretString' \
  --output text | jq -r '.api_key'

# For production environment
aws secretsmanager get-secret-value \
  --secret-id prod/ai-voice-tool/data-api-key \
  --region ap-southeast-2 \
  --profile cohesv \
  --query 'SecretString' \
  --output text | jq -r '.api_key'
```

## Deployment

The authorizer is deployed as part of the shared infrastructure stack, but requires its Docker image to be built and pushed first.

### Build and Push Image

```bash
# Build and push authorizer image for dev environment
make push-data-api-authorizer ENV=dev

# For production
make push-data-api-authorizer ENV=prod
```

### Deploy Infrastructure

The authorizer is created when you deploy the shared infrastructure:

```bash
# Deploy shared stack (includes authorizer)
./infrastructure/deploy.sh dev shared

# Or deploy all infrastructure
./infrastructure/deploy.sh dev all
```

### Deployment Order

1. **ECR Repository**: `make deploy-ecr` (creates repository)
2. **Authorizer Image**: `make push-data-api-authorizer` (builds and pushes image)
3. **Shared Stack**: `./infrastructure/deploy.sh dev shared` (creates Lambda, API key, authorizer)
4. **Data API Server**: `./infrastructure/deploy.sh dev data-api` (attaches authorizer to routes)

## Development

### Local Testing

The authorizer can be tested locally with a sample event:

```python
import json
from authorizer import lambda_handler

# Mock event from API Gateway
event = {
    "headers": {
        "x-api-key": "your-test-key"
    },
    "requestContext": {
        "http": {
            "method": "GET",
            "path": "/files/list"
        }
    }
}

result = lambda_handler(event, None)
print(json.dumps(result, indent=2))
```

### Logs

View authorizer logs in CloudWatch:

```bash
aws logs tail /aws/lambda/dev-data-api-authorizer --follow --profile cohesv
```

## Security Considerations

1. **API Key Rotation**: Keys can be rotated by updating the secret in Secrets Manager and redeploying
2. **Key Transmission**: Always use HTTPS (enforced by API Gateway)
3. **Key Storage**: Never commit API keys to source control
4. **Caching**: Authorization is cached for 5 minutes - revoked keys may work for up to 5 minutes after revocation
5. **Rate Limiting**: Consider adding API Gateway throttling for additional protection

## Troubleshooting

### 403 Forbidden Errors

**Missing Header:**
```json
{
  "message": "Forbidden"
}
```
Solution: Ensure `x-api-key` header is present in request.

**Invalid Key:**
```json
{
  "message": "Forbidden"
}
```
Solution: Verify API key matches the secret in Secrets Manager.

### 500 Internal Server Error

Check CloudWatch Logs for the authorizer Lambda:
```bash
aws logs tail /aws/lambda/dev-data-api-authorizer --follow --profile cohesv
```

Common issues:
- Authorizer cannot read secret (check IAM permissions)
- Secret not found (verify secret name matches environment)
- Lambda timeout (should be rare with 10s timeout)

## Performance

### Caching Behavior

- **First Request**: ~150-200ms (authorizer invocation + validation)
- **Cached Requests**: ~5-10ms (cache lookup only, no Lambda invocation)
- **Cache Duration**: 5 minutes per unique API key

### Cost Estimation

With caching enabled:
- **100,000 requests/month** with 10 unique API keys: ~200 Lambda invocations
- **Cost**: ~$0.00 (well within free tier)

Without caching, costs would be ~$0.20/100k requests (still negligible).

## Files

- `authorizer.py` - Lambda function code
- `Dockerfile` - Container image for Lambda deployment
- `README.md` - This file

## Related Documentation

- [data-api-server/README.md](../data-api-server/README.md) - Data API server documentation
- [infrastructure/shared/template.yaml](../infrastructure/shared/template.yaml) - Authorizer infrastructure
- [infrastructure/README.md](../infrastructure/README.md) - Deployment guide
